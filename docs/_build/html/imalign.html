<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>imalign module &mdash; amakihi  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="masking module" href="masking.html" />
    <link rel="prev" title="ePSF module" href="ePSF.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> amakihi
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">amakihi</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="CNN_model_utils.html">CNN_model_utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="amakihi.html">amakihi module</a></li>
<li class="toctree-l2"><a class="reference internal" href="astroalign_mod.html">astroalign_mod module</a></li>
<li class="toctree-l2"><a class="reference internal" href="background.html">background module</a></li>
<li class="toctree-l2"><a class="reference internal" href="crop.html">crop module</a></li>
<li class="toctree-l2"><a class="reference internal" href="crossmatch.html">crossmatch module</a></li>
<li class="toctree-l2"><a class="reference internal" href="ePSF.html">ePSF module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">imalign module</a></li>
<li class="toctree-l2"><a class="reference internal" href="masking.html">masking module</a></li>
<li class="toctree-l2"><a class="reference internal" href="plotting.html">plotting module</a></li>
<li class="toctree-l2"><a class="reference internal" href="query_2MASS.html">query_2MASS module</a></li>
<li class="toctree-l2"><a class="reference internal" href="query_CFIS.html">query_CFIS module</a></li>
<li class="toctree-l2"><a class="reference internal" href="query_DECaLS.html">query_DECaLS module</a></li>
<li class="toctree-l2"><a class="reference internal" href="query_PS1.html">query_PS1 module</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html">templates module</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_data_utils.html">training_data_utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="transient.html">transient module</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">amakihi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="modules.html">amakihi</a></li>
      <li class="breadcrumb-item active">imalign module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/imalign.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-imalign">
<span id="imalign-module"></span><h1>imalign module<a class="headerlink" href="#module-imalign" title="Permalink to this heading"></a></h1>
<p>Image alignment, A.K.A. image registration. In all, this is the trickiest part
of image differencing. Poor alignment will result in all sorts of headaches
later, and in particular, the appearance of “dipole”-like artifacts in the
final difference image.</p>
<p><strong>Important:</strong> This module makes use of a slightly modified version of the
<cite>astroalign</cite> software developed by Martin Beroiz and the TOROS Dev Team
(<a class="reference external" href="https://github.com/quatrope/astroalign">https://github.com/quatrope/astroalign</a>) in the form of my own script
<cite>astroalign_mod.py</cite>. I claim absolutely no ownership of this software. All
modifications are described in that script.</p>
<dl class="py function">
<dt class="sig sig-object py" id="imalign.image_align_imsegm">
<span class="sig-prename descclassname"><span class="pre">imalign.</span></span><span class="sig-name descname"><span class="pre">image_align_imsegm</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">science_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sciexclu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tmpexclu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sciper</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.95</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tmpper</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.95</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nsources</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">50</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thresh_sigma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">3.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pixelmin</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">etamax</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">doublealign</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sep_max</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ncrossmatch</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">8</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wcs_transfer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_sources</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_align</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'linear'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">circ_color</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'#fe01b1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_im</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#imalign.image_align_imsegm" title="Permalink to this definition"></a></dt>
<dd><p>Align a science image to a template image, using image segmentation (via
<cite>photutils</cite>) for source extraction and <cite>astroalign</cite> for alignment.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>science_file, template_file</strong> (<em>str</em>) – Science and template fits file names</p></li>
<li><p><strong>mask_file</strong> (<em>str, optional</em>) – Mask fits file name (default None)</p></li>
<li><p><strong>sciexclu, tmpexclu</strong> (<em>float, optional</em>) – Fraction of the image edges from which to exclude sources during
matching for the science and template images (default 0.05)</p></li>
<li><p><strong>sciper, tmpper</strong> (<em>float, optional</em>) – Upper flux percentile beyond which to exclude sources (default 0.95)</p></li>
<li><p><strong>nsources</strong> (<em>int, optional</em>) – Maximum number of sources to use in asterism-matching (default 50)</p></li>
<li><p><strong>thresh_sigma</strong> (<em>float or array_like, optional</em>) – Sigma threshold for source detection with image segmentation (default
3.0; can be length-2 array to assign different values for science and
template)</p></li>
<li><p><strong>pixelmin</strong> (<em>float or array_like, optional</em>) – <em>Minimum</em> pixel area of an isophote to be considered a source (default
10; can be length-2 array to assign different values for science and
template)</p></li>
<li><p><strong>etamax</strong> (<em>float or array_like, optional</em>) – <em>Maximum</em> allowed elongation for an isophote to be considered a source
(default 2.0; can be length-2 array to assign different values for
science and template)</p></li>
<li><p><strong>doublealign</strong> (<em>bool, optional</em>) – Whether to perform a second iteration of alignment for fine-tuning (see
notes for details; default False)</p></li>
<li><p><strong>sep_max</strong> (<em>float, optional</em>) – <em>Maximum</em> allowed on-sky separation (in arcsec) to cross-match a source
in the science image to the template during double alignment (default
2.0)</p></li>
<li><p><strong>ncrossmatch</strong> (<em>int, optional</em>) – Required number of cross-matched sources to proceed with double
alignment (default 8)</p></li>
<li><p><strong>wcs_transfer</strong> (<em>bool, optional</em>) – Whether to attempt to transfer WCS coordinates from the template to the
newly-aligned image (default True)</p></li>
<li><p><strong>plot_sources</strong> (<em>bool, optional</em>) – Whether to plot sources detected in the science and template images,
side-by-side, for visual inspection (default False)</p></li>
<li><p><strong>plot_align</strong> (<em>bool, optional</em>) – Whether to plot the final aligned science image (default False)</p></li>
<li><p><strong>scale</strong> (<em>{“linear”, “log”, “asinh”}</em>) – Scale to apply to the plots (default “linear”)</p></li>
<li><p><strong>circ_color</strong> (<em>str, optional</em>) – Color for the circles drawn around detected sources (default “#fe01b1
–&gt; bright pink; only relevant if <cite>plot_sources == True</cite>)</p></li>
<li><p><strong>write</strong> (<em>bool, optional</em>) – Whether to write <em>both</em> outputs (the aligned image and mask image from
the image registration footprint) (default True)</p></li>
<li><p><strong>output_im</strong> (<em>str, optional</em>) – Name for output aligned image fits file (default
<cite>science_file.replace(“.fits”, “_align.fits”)</cite>)</p></li>
<li><p><strong>output_mask</strong> (<em>str, optional</em>) – Name for output mask fits file (default
<cite>science_file.replace(“.fits”, “_align_mask.fits”)</cite>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>align_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the aligned science image</p></li>
<li><p><strong>mask_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the final mask</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p><strong>Uses a slightly modified version of astroalign.</strong></p>
<p>This function does a lot. Step by step:</p>
<ol class="arabic simple">
<li><p>Uses image segmentation to find “control points” (sources) in the
science and template images</p></li>
<li><p>Rejects sources very close to the image edges (limits set by user,
see <cite>sciexclu</cite> and <cite>tmpexclu</cite>)</p></li>
<li><p>Rejects sources below some minimum isophotal area <cite>pixelmin</cite></p></li>
<li><p>Rejects sources with elongation above <cite>etamax</cite></p></li>
<li><p>Rejects sources above some upper flux percentile (set by user, see
<cite>sciper</cite> and <cite>tmpper</cite>)</p></li>
<li><p>Retains at most <cite>nsources</cite> control points</p></li>
<li><p><strong>Control points are passed to astroalign</strong>, which finds invariants
between the source and template control point sets and computes the
affine transformation which aligns the source image to the template
image, and then applies this transformation to the science image</p></li>
<li><p><strong>Optional (if doublealign == True)</strong>: With the newly aligned image
and WCS coordinates in both science and template images, constructs
pairs of sources at the same coordinates, and computes another
transformation which respects these pairs to fine-tune the alignment</p></li>
</ol>
<p><strong>TO-DO:</strong></p>
<ul class="simple">
<li><p>Allow naming of output plots</p></li>
<li><p>Fix: During transfer of WCS header from PS1 to CFHT, WCS becomes nonsense</p></li>
</ul>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="imalign.image_align_astrometry">
<span class="sig-prename descclassname"><span class="pre">imalign.</span></span><span class="sig-name descname"><span class="pre">image_align_astrometry</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">science_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sciexclu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tmpexclu</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sciper</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.95</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tmpper</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.95</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nsources</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">50</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bkgsubbed</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">astrom_sigma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">8.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">psf_sigma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">5.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wcs_transfer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_sources</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_align</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'linear'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">circ_color</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'#fe01b1'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_im</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#imalign.image_align_astrometry" title="Permalink to this definition"></a></dt>
<dd><p>Align a science image to a template image, using <cite>astrometry.net</cite> for
source extraction and <cite>astroalign</cite> for alignment.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>science_file, template_file</strong> (<em>str</em>) – Science and template fits file names</p></li>
<li><p><strong>mask_file</strong> (<em>str, optional</em>) – Mask fits file name (default None)</p></li>
<li><p><strong>sciexclu, tmpexclu</strong> (<em>float, optional</em>) – Fraction of the image edges from which to exclude sources during
matching for the science and template images (default 0.05)</p></li>
<li><p><strong>sciper, tmpper</strong> (<em>float, optional</em>) – Upper flux percentile beyond which to exclude sources (default 0.95)</p></li>
<li><p><strong>nsources</strong> (<em>int, optional</em>) – Maximum number of sources to use in asterism-matching (default 50)</p></li>
<li><p><strong>bkgsubbed</strong> (<em>bool or array_like, optional</em>) – Whether the images have already been background-subtracted (default
False; can be length-2 array to assign different bools for science
and template)</p></li>
<li><p><strong>astrom_sigma</strong> (<em>float or array_like, optional</em>) – Detection significance when using <cite>image2xy</cite> in <cite>astrometry.net</cite> to
find sources (default 8.0, can be length-2 array to assign different
values for science and template)</p></li>
<li><p><strong>psf_sigma</strong> (<em>float or array_like, optional</em>) – Sigma of the approximate Gaussian PSF of the images (default 5.0; can
be length-2 array to assign different values for science and template)</p></li>
<li><p><strong>keep</strong> (<em>bool, optional</em>) – Whether to keep the source list files (<cite>.xy.fits</cite> files; default False)</p></li>
<li><p><strong>wcs_transfer</strong> (<em>bool, optional</em>) – Whether to attempt to transfer WCS coordinates from the template to the
newly-aligned image (default True)</p></li>
<li><p><strong>plot_sources</strong> (<em>bool, optional</em>) – Whether to plot sources detected in the science and template images,
side-by-side, for visual inspection (default False)</p></li>
<li><p><strong>plot_align</strong> (<em>bool, optional</em>) – Whether to plot the final aligned science image (default False)</p></li>
<li><p><strong>scale</strong> (<em>{“linear”, “log”, “asinh”}</em>) – Scale to apply to the plots (default “linear”)</p></li>
<li><p><strong>circ_color</strong> (<em>str, optional</em>) – Color for the circles drawn around detected sources (default “#fe01b1
–&gt; bright pink; only relevant if <cite>plot_sources == True</cite>)</p></li>
<li><p><strong>write</strong> (<em>bool, optional</em>) – Whether to write <em>both</em> outputs (the aligned image and mask image from
the image registration footprint) (default True)</p></li>
<li><p><strong>output_im</strong> (<em>str, optional</em>) – Name for output aligned image fits file (default
<cite>science_file.replace(“.fits”, “_align.fits”)</cite>)</p></li>
<li><p><strong>output_mask</strong> (<em>str, optional</em>) – Name for output mask fits file (default
<cite>science_file.replace(“.fits”, “_align_mask.fits”)</cite>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>align_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the aligned science image</p></li>
<li><p><strong>mask_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the final mask</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p><strong>Uses a slightly modified version of astroalign.</strong></p>
<p>This function does a lot. Step by step:</p>
<ol class="arabic simple">
<li><p>Uses <cite>image2xy</cite> of <cite>astrometry.net</cite> to find “control points” (sources)
in the science and template images</p></li>
<li><p>Retains at most <cite>nsources</cite> control points</p></li>
<li><p><strong>Control points are passed to astroalign</strong>, which finds invariants
between the source and template control point sets and computes the
affine transformation which aligns the source image to the template
image, and then applies this transformation to the science image</p></li>
</ol>
<p><strong>Note:</strong> <cite>image2xy</cite> has a hard time doing basic background subtraction
when an image has nans in it. Before trying alignment with an image which
contains nans, it is suggested to set all nans to 0 instead.</p>
<p><strong>TO-DO:</strong></p>
<ul class="simple">
<li><p>Allow naming of output plots</p></li>
<li><p>Fix: During transfer of WCS header from PS1 to CFHT, WCS becomes nonsense</p></li>
</ul>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="imalign.image_align">
<span class="sig-prename descclassname"><span class="pre">imalign.</span></span><span class="sig-name descname"><span class="pre">image_align</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">science_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">thresh_sigma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">3.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wcs_transfer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_align</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_im</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#imalign.image_align" title="Permalink to this definition"></a></dt>
<dd><p>Align a science image to a template image using <cite>astroalign</cite> for <strong>all</strong>
steps, including source extraction and the final alignment.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>science_file, template_file</strong> (<em>str</em>) – Science and template fits file names</p></li>
<li><p><strong>mask_file</strong> (<em>str, optional</em>) – Mask fits file name (default None)</p></li>
<li><p><strong>thresh_sigma</strong> (<em>float or array_like, optional</em>) – Sigma threshold for source detection within astroalign (default 3.0)</p></li>
<li><p><strong>wcs_transfer</strong> (<em>bool, optional</em>) – Whether to attempt to transfer WCS coordinates from the template to the
newly-aligned image (default True)</p></li>
<li><p><strong>plot_align</strong> (<em>bool, optional</em>) – Whether to plot the final aligned science image (default False)</p></li>
<li><p><strong>scale</strong> (<em>{“linear”, “log”, “asinh”}</em>) – Scale to apply to the plots (default “linear”)</p></li>
<li><p><strong>write</strong> (<em>bool, optional</em>) – Whether to write <em>both</em> outputs (the aligned image and mask image from
the image registration footprint) (default True)</p></li>
<li><p><strong>output_im</strong> (<em>str, optional</em>) – Name for output aligned image fits file (default
<cite>science_file.replace(“.fits”, “_align.fits”)</cite>)</p></li>
<li><p><strong>output_mask</strong> (<em>str, optional</em>) – Name for output mask fits file (default
<cite>science_file.replace(“.fits”, “_align_mask.fits”)</cite>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>align_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the aligned science image</p></li>
<li><p><strong>mask_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the final mask</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p><strong>Uses a slightly modified version of astroalign.</strong></p>
<p><strong>TO-DO:</strong></p>
<ul class="simple">
<li><p>Allow naming of output plot</p></li>
<li><p>Fix: During transfer of WCS header from PS1 to CFHT, WCS becomes nonsense</p></li>
</ul>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="imalign.image_align_morph">
<span class="sig-prename descclassname"><span class="pre">imalign.</span></span><span class="sig-name descname"><span class="pre">image_align_morph</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">science_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mask_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flip</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maxoffset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">30.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wcs_transfer</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_align</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'linear'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">write</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_im</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_mask</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#imalign.image_align_morph" title="Permalink to this definition"></a></dt>
<dd><p>Align a science image to a template image using <cite>image_registration</cite>,
which relies on image morphology rather than cross-matching control points.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>science_file, template_file</strong> (<em>str</em>) – Science and template fits file names</p></li>
<li><p><strong>mask_file</strong> (<em>str, optional</em>) – Mask fits file name (default None)</p></li>
<li><p><strong>flip</strong> (<em>bool, optional</em>) – Whether to flip the science image before attempting to align it
(default False)</p></li>
<li><p><strong>maxoffset</strong> (<em>float, optional</em>) – <em>Maximum</em> allowed offset between science and template images to
consider the solution a good alignment (default 30.0)</p></li>
<li><p><strong>wcs_transfer</strong> (<em>bool, optional</em>) – Whether to attempt to transfer WCS coordinates from the template to the
newly-aligned image (default True)</p></li>
<li><p><strong>plot_align</strong> (<em>bool, optional</em>) – Whether to plot the final aligned science image (default False)</p></li>
<li><p><strong>scale</strong> (<em>{“linear”, “log”, “asinh”}</em>) – Scale to apply to the plots (default “linear”)</p></li>
<li><p><strong>write</strong> (<em>bool, optional</em>) – Whether to write <em>both</em> outputs (the aligned image and mask image from
the image registration footprint) (default True)</p></li>
<li><p><strong>output_im</strong> (<em>str, optional</em>) – Name for output aligned image fits file (default
<cite>science_file.replace(“.fits”, “_align.fits”)</cite>)</p></li>
<li><p><strong>output_mask</strong> (<em>str, optional</em>) – Name for output mask fits file (default
<cite>science_file.replace(“.fits”, “_align_mask.fits”)</cite>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>align_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the aligned science image</p></li>
<li><p><strong>mask_hdu</strong> (<em>astropy.io.fits.PrimaryHDU</em>) – New HDU (image + header) of the final mask</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>Calls on <cite>image_registration</cite> to align the science image with the target to
allow for proper image differencing. Also finds a mask of out of bounds
pixels to ignore during differencing. The image registration in this
function is based on morphology and edge detection in the image, in
contrast with <cite>image_align_segm()</cite>, <cite>image_align_astrometry()</cite>, and
<cite>image_align()</cite>, which use asterism-matching to align the two images.</p>
<p>For images composed mostly of point sources, use image_align. For images
composed mainly of galaxies/nebulae and/or other extended objects, use this
function.</p>
<p><strong>TO-DO:</strong></p>
<ul class="simple">
<li><p>Fix: WCS header of aligned image doesn’t always seem correct for alignment
with non-CFHT templates</p></li>
</ul>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="imalign.solve_field">
<span class="sig-prename descclassname"><span class="pre">imalign.</span></span><span class="sig-name descname"><span class="pre">solve_field</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">image_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">remove_PC</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">verify</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prebkgsub</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">guess_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">read_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">pixscale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale_tol</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.05</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">verbose</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#imalign.solve_field" title="Permalink to this definition"></a></dt>
<dd><p>Use the <cite>solve-field</cite> command of <cite>astrometry.net</cite> to find an astrometric
solution for an image and output an updated, solved fits file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>image_file</strong> (<em>str</em>) – Filename for fits image to solve with <cite>astrometry.net</cite>’s
<cite>solve-field</cite></p></li>
<li><p><strong>remove_PC</strong> (<em>bool, optional</em>) – Whether to look for “PC00i00j” headers and remove them before solving,
if present (default True)</p></li>
<li><p><strong>verify</strong> (<em>bool, optional</em>) – Whether to try and verify existing WCS headers when solving (default
False)</p></li>
<li><p><strong>prebkgsub</strong> (<em>bool, optional</em>) – Whether the input image has already been background-subtracted (default
False)</p></li>
<li><p><strong>guess_scale</strong> (<em>bool, optional</em>) – Whether to try and guess the scale of the image from WCS headers
(default False)</p></li>
<li><p><strong>read_scale</strong> (<em>bool, optional</em>) – Whether to instead search for a “PIXSCAL1” header containing the image
pixel scale (default True; ignored if <cite>guess_scale == True</cite>)</p></li>
<li><p><strong>pixscale</strong> (<em>float, optional</em>) – Image scale in arcsec per pixel, if known (default None; will be
ignored if <cite>guess_scale == True</cite> <em>OR</em> if <cite>read_scale == True</cite> and the
“PIXSCAL1” header is successfully found)</p></li>
<li><p><strong>scale_tol</strong> (<em>float, optional</em>) – Degree of +/- tolerance for the pixel scale of the image (in arcsec per
pix), if the header “PIXSCAL1” is found <em>or</em> if a scale is given
(default 0.05; see notes for details)</p></li>
<li><p><strong>verbose</strong> (<em>{0, 1, 2}, optional</em>) – Level of verbosity (default 0)</p></li>
<li><p><strong>output</strong> (<em>str, optional</em>) – Name for output updated .fits file (default
<cite>image_file.replace(“.fits”,”_solved.fits”)</cite>)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The STDOUT produced by <cite>astrometry.net</cite></p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>str</p>
</dd>
<dt class="field-even">Raises</dt>
<dd class="field-even"><p><strong>ValueError</strong> – If the output filename and input filename are the same</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>If hdr[“PIXSCAL1”] = 0.185 and <cite>scale_tol = 0.05</cite>, <cite>solve-field</cite> will only
look for solutions with a pixel scale of 0.185 +/- 0.05 arcsec per pix.</p>
<p><strong>Note:</strong> Output filename must be different from input filename.</p>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ePSF.html" class="btn btn-neutral float-left" title="ePSF module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="masking.html" class="btn btn-neutral float-right" title="masking module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Nicholas Vieira.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>